diff --git a/lib/handler/mruby.c b/lib/handler/mruby.c
index eef2307..0b959a2 100644
--- a/lib/handler/mruby.c
+++ b/lib/handler/mruby.c
@@ -152,6 +152,14 @@ mrb_value h2o_mruby_compile_code(mrb_state *mrb, h2o_mruby_config_vars_t *config
         abort();
     }
 
+    /* adjest stack length of toplevel environment */
+    if (mrb->c->cibase->env) {
+        struct REnv *e = mrb->c->cibase->env;
+        if (MRB_ENV_STACK_LEN(e) < proc->body.irep->nlocals) {
+            MRB_SET_ENV_STACK_LEN(e, proc->body.irep->nlocals);
+        }
+    }
+
     /* reset configuration context */
     h2o_mruby_eval_expr(mrb, "H2O::ConfigurationContext.reset");
     h2o_mruby_assert(mrb);
